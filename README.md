# venta_vehiculos_soap_proyecto

<img width="203" height="193" alt="image" src="https://github.com/user-attachments/assets/acd0ce8a-579d-497b-a76e-797430d0bb13" />

# Autor: Giovanny & ChatGPT . :.

<img width="2546" height="1079" alt="image" src="https://github.com/user-attachments/assets/0be6b8b5-fd9e-4905-95d7-d87e7e720e33" />

<img width="2550" height="1079" alt="image" src="https://github.com/user-attachments/assets/0e276bbd-6dca-4bde-8144-0e9e6141c1be" />

# VentaVehiculosSOAP üöóüì¶

Proyecto de ejemplo en **Python** que implementa un **servicio SOAP** para recibir un XML con informaci√≥n de clientes, veh√≠culos y compras , procesarlo y registrar los datos en una **base de datos Oracle** mediante un procedimiento almacenado .

---

## üìÇ Estructura del repositorio : 

- **requirements.txt** ‚Äî dependencias del proyecto.  
- **app.py** ‚Äî servidor SOAP (Flask + Spyne) que expone el m√©todo `procesarXmlVenta`.  
- **parser.py** ‚Äî funciones para parsear el XML y mapearlo a par√°metros para Oracle .  
- **db.py** ‚Äî conexi√≥n a Oracle usando `python-oracledb` y llamada al procedimiento almacenado .  
- **stored_procedure.sql** ‚Äî ejemplo de procedimiento PL/SQL que espera el proyecto .  
- **sample_venta.xml** ‚Äî plantilla de ejemplo de XML de entrada .  

---

## ‚öôÔ∏è Dependencias

`requirements.txt`:

```txt
Flask>=2.0
spyne>=2.13
lxml>=4.9
python-oracledb>=1.0
python-dotenv>=1.0

üóÑÔ∏è sql:

---------------------------------------------------------
-- Tablas de ejemplo
---------------------------------------------------------
CREATE TABLE clientes (
  id_cliente     VARCHAR2(20) PRIMARY KEY,
  nombre         VARCHAR2(100),
  documento      VARCHAR2(50),
  email          VARCHAR2(100),
  telefono       VARCHAR2(20)
);

CREATE TABLE vehiculos (
  vin            VARCHAR2(50) PRIMARY KEY,
  marca          VARCHAR2(50),
  modelo         VARCHAR2(50),
  ano            NUMBER(4),
  precio         NUMBER(12,2)
);

CREATE TABLE compras (
  id_compra      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  id_cliente     VARCHAR2(20),
  vin            VARCHAR2(50),
  id_item        VARCHAR2(20),
  descripcion    VARCHAR2(200),
  cantidad       NUMBER,
  valor          NUMBER(12,2),
  FOREIGN KEY (id_cliente) REFERENCES clientes(id_cliente),
  FOREIGN KEY (vin) REFERENCES vehiculos(vin)
);

---------------------------------------------------------
-- Procedimiento almacenado
---------------------------------------------------------
CREATE OR REPLACE PROCEDURE registrar_venta_xml(
  p_xml    IN  CLOB,
  p_result OUT VARCHAR2
) AS
BEGIN
  -- Insertar CLIENTE
  MERGE INTO clientes c
  USING (
    SELECT x.id, x.nombre, x.documento, x.email, x.telefono
    FROM XMLTABLE(
      '/Venta/Cliente'
      PASSING XMLTYPE(p_xml)
      COLUMNS
        id        VARCHAR2(20)   PATH 'Id',
        nombre    VARCHAR2(100)  PATH 'Nombre',
        documento VARCHAR2(50)   PATH 'Documento',
        email     VARCHAR2(100)  PATH 'Email',
        telefono  VARCHAR2(20)   PATH 'Telefono'
    ) x
  ) data
  ON (c.id_cliente = data.id)
  WHEN MATCHED THEN
    UPDATE SET c.nombre = data.nombre,
               c.documento = data.documento,
               c.email = data.email,
               c.telefono = data.telefono
  WHEN NOT MATCHED THEN
    INSERT (id_cliente, nombre, documento, email, telefono)
    VALUES (data.id, data.nombre, data.documento, data.email, data.telefono);

  -- Insertar VEHICULO
  MERGE INTO vehiculos v
  USING (
    SELECT x.vin, x.marca, x.modelo, x.ano, x.precio
    FROM XMLTABLE(
      '/Venta/Vehiculo'
      PASSING XMLTYPE(p_xml)
      COLUMNS
        vin    VARCHAR2(50)   PATH 'Vin',
        marca  VARCHAR2(50)   PATH 'Marca',
        modelo VARCHAR2(50)   PATH 'Modelo',
        ano    NUMBER(4)      PATH 'Ano',
        precio NUMBER(12,2)   PATH 'Precio'
    ) x
  ) data
  ON (v.vin = data.vin)
  WHEN MATCHED THEN
    UPDATE SET v.marca = data.marca,
               v.modelo = data.modelo,
               v.ano = data.ano,
               v.precio = data.precio
  WHEN NOT MATCHED THEN
    INSERT (vin, marca, modelo, ano, precio)
    VALUES (data.vin, data.marca, data.modelo, data.ano, data.precio);

  -- Insertar COMPRAS
  INSERT INTO compras (id_cliente, vin, id_item, descripcion, cantidad, valor)
  SELECT c.id_cliente, v.vin, x.id_item, x.descripcion, x.cantidad, x.valor
  FROM XMLTABLE(
    '/Venta/Compras/Item'
    PASSING XMLTYPE(p_xml)
    COLUMNS
      id_item     VARCHAR2(20)   PATH 'IdItem',
      descripcion VARCHAR2(200)  PATH 'Descripcion',
      cantidad    NUMBER         PATH 'Cantidad',
      valor       NUMBER(12,2)   PATH 'Valor'
  ) x
  CROSS JOIN (
    SELECT id_cliente FROM XMLTABLE('/Venta/Cliente/Id' PASSING XMLTYPE(p_xml) COLUMNS id_cliente VARCHAR2(20) PATH '.') 
  ) c
  CROSS JOIN (
    SELECT vin FROM XMLTABLE('/Venta/Vehiculo/Vin' PASSING XMLTYPE(p_xml) COLUMNS vin VARCHAR2(50) PATH '.') 
  ) v;

  p_result := 'OK';

EXCEPTION
  WHEN OTHERS THEN
    p_result := 'ERROR: ' || SQLERRM;
END registrar_venta_xml;
/

üîé Nota: en entornos reales se recomienda usar tablas y procedimientos espec√≠ficos que reciban par√°metros individuales (cliente, veh√≠culo, items)
para mayor rendimiento y control transaccional. Este ejemplo usa un √∫nico CLOB para simplificar .

üìë XML de entrada .
sample_venta.xml :

<?xml version="1.0" encoding="UTF-8"?>
<Venta>
  <Cliente>
    <Id>12345</Id>
    <Nombre>Juan Perez</Nombre>
    <Documento>CC123456</Documento>
    <Email>juan.perez@example.com</Email>
    <Telefono>3101234567</Telefono>
  </Cliente>
  <Vehiculo>
    <Vin>1HGCM82633A004352</Vin>
    <Marca>Honda</Marca>
    <Modelo>Civic</Modelo>
    <Ano>2020</Ano>
    <Precio>35000</Precio>
  </Vehiculo>
  <Compras>
    <Item>
      <IdItem>1</IdItem>
      <Descripcion>Seguro anual</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>1200</Valor>
    </Item>
    <Item>
      <IdItem>2</IdItem>
      <Descripcion>GPS integrado</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>800</Valor>
    </Item>
    <Item>
      <IdItem>3</IdItem>
      <Descripcion>Kit de carretera</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>150</Valor>
    </Item>
    <Item>
      <IdItem>4</IdItem>
      <Descripcion>Mantenimiento preventivo</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>500</Valor>
    </Item>
    <Item>
      <IdItem>5</IdItem>
      <Descripcion>Polarizado de vidrios</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>200</Valor>
    </Item>
    <Item>
      <IdItem>6</IdItem>
      <Descripcion>Rines de lujo</Descripcion>
      <Cantidad>4</Cantidad>
      <Valor>2000</Valor>
    </Item>
    <Item>
      <IdItem>7</IdItem>
      <Descripcion>Tapicer√≠a en cuero</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>3000</Valor>
    </Item>
    <Item>
      <IdItem>8</IdItem>
      <Descripcion>Parrilla de techo</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>600</Valor>
    </Item>
    <Item>
      <IdItem>9</IdItem>
      <Descripcion>Sistema de sonido premium</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>2500</Valor>
    </Item>
    <Item>
      <IdItem>10</IdItem>
      <Descripcion>Luces LED</Descripcion>
      <Cantidad>2</Cantidad>
      <Valor>400</Valor>
    </Item>
    <Item>
      <IdItem>11</IdItem>
      <Descripcion>Sensor de parqueo</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>700</Valor>
    </Item>
    <Item>
      <IdItem>12</IdItem>
      <Descripcion>C√°mara de reversa</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>900</Valor>
    </Item>
    <Item>
      <IdItem>13</IdItem>
      <Descripcion>Seguro de llantas</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>500</Valor>
    </Item>
    <Item>
      <IdItem>14</IdItem>
      <Descripcion>Alarma antirrobo</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>1100</Valor>
    </Item>
    <Item>
      <IdItem>15</IdItem>
      <Descripcion>Extintor</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>100</Valor>
    </Item>
    <Item>
      <IdItem>16</IdItem>
      <Descripcion>Gato hidr√°ulico</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>180</Valor>
    </Item>
    <Item>
      <IdItem>17</IdItem>
      <Descripcion>Juego de herramientas</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>250</Valor>
    </Item>
    <Item>
      <IdItem>18</IdItem>
      <Descripcion>Cubre asientos</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>320</Valor>
    </Item>
    <Item>
      <IdItem>19</IdItem>
      <Descripcion>Seguro contra robo</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>1800</Valor>
    </Item>
    <Item>
      <IdItem>20</IdItem>
      <Descripcion>Extensi√≥n de garant√≠a</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>2200</Valor>
    </Item>
    <Item>
      <IdItem>21</IdItem>
      <Descripcion>Kit de limpieza</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>80</Valor>
    </Item>
    <Item>
      <IdItem>22</IdItem>
      <Descripcion>Bater√≠a adicional</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>400</Valor>
    </Item>
    <Item>
      <IdItem>23</IdItem>
      <Descripcion>Seguro de accidentes</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>1300</Valor>
    </Item>
    <Item>
      <IdItem>24</IdItem>
      <Descripcion>Manuales de usuario</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>50</Valor>
    </Item>
    <Item>
      <IdItem>25</IdItem>
      <Descripcion>Revisi√≥n t√©cnico-mec√°nica</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>600</Valor>
    </Item>
    <Item>
      <IdItem>26</IdItem>
      <Descripcion>Kit de emergencia m√©dica</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>150</Valor>
    </Item>
    <Item>
      <IdItem>27</IdItem>
      <Descripcion>Llanta de repuesto</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>500</Valor>
    </Item>
    <Item>
      <IdItem>28</IdItem>
      <Descripcion>Seguro extendido</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>2500</Valor>
    </Item>
    <Item>
      <IdItem>29</IdItem>
      <Descripcion>Accesorios interiores</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>600</Valor>
    </Item>
    <Item>
      <IdItem>30</IdItem>
      <Descripcion>Accesorios exteriores</Descripcion>
      <Cantidad>1</Cantidad>
      <Valor>700</Valor>
    </Item>
  </Compras>
</Venta>

üêç C√≥digo principal .
üîó Conexi√≥n a Oracle :
db.py maneja un pool de conexiones y llama al procedimiento almacenado con un bloque PL/SQL:

def call_registrar_venta_xml(xml_text: str) -> str:
    if pool is None:
        init_pool()
    conn = pool.acquire()
    try:
        cur = conn.cursor()
        result_var = cur.var(str)
        cur.execute("BEGIN registrar_venta_xml(:p_xml, :p_result); END;",
                    p_xml=xml_text, p_result=result_var)
        return result_var.getvalue()
    finally:
        pool.release(conn)

üìù Parseo de XML .
parser.py usa lxml y devuelve un diccionario:

def parse_venta_xml(xml_text: str) -> dict:
    root = etree.fromstring(xml_text.encode('utf-8'))

    cliente = {
        'id': _get_text(root, './Cliente/Id'),
        'nombre': _get_text(root, './Cliente/Nombre'),
        'documento': _get_text(root, './Cliente/Documento'),
        'email': _get_text(root, './Cliente/Email'),
        'telefono': _get_text(root, './Cliente/Telefono'),
    }

    vehiculo = {
        'vin': _get_text(root, './Vehiculo/Vin'),
        'marca': _get_text(root, './Vehiculo/Marca'),
        'modelo': _get_text(root, './Vehiculo/Modelo'),
        'ano': _get_text(root, './Vehiculo/Ano'),
        'precio': _get_text(root, './Vehiculo/Precio'),
    }

    items = []
    for item in root.xpath('./Compras/Item'):
        items.append({
            'id': _get_text(item, './IdItem'),
            'desc': _get_text(item, './Descripcion'),
            'cantidad': _get_text(item, './Cantidad'),
            'valor': _get_text(item, './Valor'),
        })

    return {'cliente': cliente, 'vehiculo': vehiculo, 'items': items}

üåê Servidor SOAP .
app.py define el servicio con Flask + Spyne :

class VentaService(ServiceBase):
    @rpc(Unicode, _returns=Unicode)
    def procesarXmlVenta(ctx, xml_text):
        if not xml_text or len(xml_text.strip()) == 0:
            return 'ERROR: XML vac√≠o'
        try:
            parsed = parse_venta_xml(xml_text)
        except Exception as e:
            return f'ERROR_PARSE: {str(e)}'
        try:
            result = call_registrar_venta_xml(xml_text)
            return result
        except Exception as e:
            return f'ERROR_DB: {str(e)}'

El endpoint SOAP queda disponible en : 
# arduino .

http://127.0.0.1:8000/soap

üß™ C√≥mo probarlo :
Usando curl:
bash :

curl -X POST \
  -H "Content-Type: text/xml; charset=utf-8" \
  --data-binary @sample_venta.xml \
  http://127.0.0.1:8000/soap

Usando zeep (cliente Python):
(opcional: se puede agregar un cliente_soap.py con zeep) .

üîí Seguridad y producci√≥n
Usa variables de entorno para credenciales (.env).
Habilita TLS (HTTPS) en producci√≥n.
Limita tama√±o de payload y valida esquemas XML (evita ataques XXE/DoS).
Considera transformar XML a par√°metros individuales para evitar SQL/PLSQL injection .

‚ñ∂Ô∏è Pasos para ejecutar localmente :
Crear y activar un virtualenv.
Instalar dependencias:
bash
pip install -r requirements.txt

Crear archivo .env con:
env
ORACLE_USER=usuario
ORACLE_PW=clave
ORACLE_DSN=host:puerto/servicio
Crear procedimiento almacenado en Oracle con stored_procedure.sql .

Ejecutar servidor :
bash
python app.py

Enviar peticiones SOAP a :
arduino .
http://127.0.0.1:8000/soap

üìå Observaciones finales
Se utiliza Spyne para el servidor SOAP .
Conexi√≥n a Oracle con la librer√≠a oficial python-oracledb .
Ajusta XPaths y el procedimiento almacenado seg√∫n tu esquema real .

üì¶ Extras (opcionales)
cliente_soap.py con zeep .
Dockerfile para contenerizar la aplicaci√≥n .
setup.sql con tablas e inserts de ejemplo .
